<!DOCTYPE html><html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LOVIXA DASHBOARD</title>
  <!-- Material Icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
  <style>
    :root {
      --bg: #0d0d0d;
      --surface: #1e1e1e;
      --primary: #4caf50;
      --text: #ffffff;
    }* { box-sizing: border-box; }

body {
  margin: 0;
  height: 100vh;
  display: flex;
  flex-direction: column;
  font-family: "Segoe UI", Arial, sans-serif;
  background: var(--bg);
  color: var(--text);
}

/* Top Bar */
.topbar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 8px 12px;
  background: var(--surface);
  box-shadow: 0 0 6px rgba(0, 0, 0, 0.4);
}

.topbar h1 {
  margin: 0;
  font-size: 1.4rem;
  letter-spacing: 1px;
}

.icon-btn {
  background: none;
  border: none;
  color: var(--text);
  font-size: 28px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 4px;
}

/* Map */
#map { flex: 1; width: 100%; }

/* Bottom Navigation */
.bottom-nav {
  display: flex;
  justify-content: space-around;
  align-items: center;
  height: 56px;
  background: var(--surface);
  box-shadow: 0 -2px 6px rgba(0, 0, 0, 0.4);
}

.nav-btn {
  color: var(--text);
  font-size: 28px;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 100%;
  height: 100%;
  text-decoration: none;
}

/* Avatar Marker */
.avatar-marker {
  width: 44px;
  height: 44px;
  border-radius: 50%;
  background-size: cover;
  background-position: center;
  border: 3px solid var(--primary);
  box-shadow: 0 0 6px rgba(0, 0, 0, 0.6);
}

/* Popup */
.popup { display: flex; flex-direction: column; gap: 4px; }

.popup button {
  border: none;
  border-radius: 8px;
  padding: 6px 12px;
  font-size: 14px;
  cursor: pointer;
  color: #fff;
}

.popup .msg-btn { background: var(--primary); }
.popup .profile-btn { background: #4285f4; }

  </style>
</head>
<body>
  <!-- Top Bar -->
  <header class="topbar">
    <button id="location-toggle" class="icon-btn material-icons" title="Konum Göster/Gizle">place</button>
    <h1>LOVIXA</h1>
    <a href="notifications.html" class="icon-btn material-icons" title="Bildirimler">favorite</a>
  </header>  <!-- Map -->  <main id="map"></main>  <!-- Bottom Navigation -->  <nav class="bottom-nav">
    <a href="dashboard.html" class="nav-btn material-icons" title="Anasayfa">home</a>
    <a href="messages.html" class="nav-btn material-icons" title="Mesajlar">chat</a>
    <a href="profile.html" class="nav-btn material-icons" title="Profil">person</a>
  </nav>  <!-- Firebase, Firestore & Google Maps Logic -->  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, updateDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    // Firebase Config (Map API key gömülü)
    const firebaseConfig = {
      apiKey: "AIzaSyDslfjDqEpqQekNxh9e4OqYYkxdf2TUI7E",
      authDomain: "silicon-park-462509-r3.firebaseapp.com",
      projectId: "silicon-park-462509-r3",
      storageBucket: "silicon-park-462509-r3.appspot.com",
      messagingSenderId: "463275849598",
      appId: "1:463275849598:web:19ffa6e6e5e1ff5077252f",
      measurementId: "G-8CTH7CQ2SS"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let map;
    let myMarker;
    let visible = true;
    const otherMarkers = new Map(); // uid -> marker

    // ——— AUTH DURUMU ———
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        window.location.href = "login.html";
      } else {
        initMapAndLocation(user);
      }
    });

    // ——— MAP + GEO + FIRESTORE ———
    function initMapAndLocation(user) {
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const myPos = { lat: pos.coords.latitude, lng: pos.coords.longitude };
          createMap(myPos);
          myMarker = new google.maps.marker.AdvancedMarkerElement({
            map,
            position: myPos,
            content: createAvatarMarker(`https://i.pravatar.cc/100?u=${user.uid}`)
          });
          writeLocation(user.uid, myPos);
          // 5 saniyede bir güncelle
          setInterval(() => {
            navigator.geolocation.getCurrentPosition((p) => {
              const newPos = { lat: p.coords.latitude, lng: p.coords.longitude };
              if (myMarker) myMarker.position = newPos;
              writeLocation(user.uid, newPos);
            });
          }, 5000);
          listenOthers(user.uid);
        },
        (err) => alert("Konum alınamadı: " + err.message),
        { enableHighAccuracy: true }
      );
    }

    function createMap(center) {
      map = new google.maps.Map(document.getElementById("map"), {
        center,
        zoom: 14,
        mapId: "a772948b1f9c04b5" // opsiyonel koyu tema ID
      });

      // Konum göster / gizle
      document.getElementById("location-toggle").addEventListener("click", () => {
        visible = !visible;
        myMarker.map = visible ? map : null;
      });
    }

    // Avatar marker HTML oluşturur
    function createAvatarMarker(url) {
      const d = document.createElement("div");
      d.className = "avatar-marker";
      d.style.backgroundImage = `url(${url})`;
      return d;
    }

    // Firestore'a konum yaz/merge et
    function writeLocation(uid, coords) {
      const ref = doc(db, "activeUsers", uid);
      setDoc(ref, { lat: coords.lat, lng: coords.lng, ts: Date.now() }, { merge: true });
    }

    // Diğer kullanıcıları dinle & haritaya yerleştir
    function listenOthers(myUid) {
      const col = collection(db, "activeUsers");
      onSnapshot(col, (snap) => {
        snap.docChanges().forEach((change) => {
          const uid = change.doc.id;
          if (uid === myUid) return;
          const data = change.doc.data();

          if (change.type === "removed") {
            if (otherMarkers.has(uid)) {
              otherMarkers.get(uid).map = null;
              otherMarkers.delete(uid);
            }
          } else {
            let marker = otherMarkers.get(uid);
            if (!marker) {
              marker = new google.maps.marker.AdvancedMarkerElement({
                map,
                position: { lat: data.lat, lng: data.lng },
                content: createAvatarMarker(`https://i.pravatar.cc/100?u=${uid}`)
              });
              marker.addListener("gmp-click", () => {
                const info = new google.maps.InfoWindow({
                  content: popupHTML(uid)
                });
                info.open(map, marker);
              });
              otherMarkers.set(uid, marker);
            } else {
              marker.position = { lat: data.lat, lng: data.lng };
            }
          }
        });
      });
    }

    // InfoWindow içeriği
    function popupHTML(uid) {
      return `
        <div class="popup">
          <button class="msg-btn" onclick="window.location.href='messages.html?uid=${uid}'">Mesaj Göster</button>
          <button class="profile-btn" onclick="window.location.href='profile.html?uid=${uid}'">Profile Git</button>
        </div>`;
    }
  </script>  <!-- Google Maps -->  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDslfjDqEpqQekNxh9e4OqYYkxdf2TUI7E&libraries=marker" async defer></script>  <script>
    // Harita callback'i API parametresinde tanımlı olmadığı için placeholder
    function initMap() { /* Auth sonrası JS'te oluşturuluyor */ }
  </script></body>
</html>