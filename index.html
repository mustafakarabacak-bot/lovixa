<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sosyal Harita ve Mesajlaşma</title>
    <style>
        body, html { margin: 0; padding: 0; height: 100%; font-family: Arial, sans-serif; }
        #map { height: calc(100% - 50px); width: 100%; }
        #bottom-nav { position: fixed; bottom: 0; width: 100%; background: #333; display: flex; justify-content: space-around; padding: 10px 0; }
        #bottom-nav button { background: #555; color: white; border: none; padding: 10px; cursor: pointer; flex: 1; margin: 0 5px; }
        #bottom-nav button.active { background: #007bff; }
        #username-popup { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        #username-form { background: white; padding: 20px; border-radius: 5px; text-align: center; width: 90%; max-width: 400px; }
        #messages-section, #chat-section { display: none; padding: 20px; height: calc(100% - 50px); overflow-y: auto; }
        #messages-list, #chat-messages { background: #f9f9f9; padding: 10px; min-height: 300px; border-radius: 5px; margin-bottom: 10px; }
        .message-item { padding: 10px; border-bottom: 1px solid #ddd; cursor: pointer; display: flex; align-items: center; }
        .message-item img { width: 40px; height: 40px; border-radius: 50%; margin-right: 10px; }
        .chat-message { padding: 10px; margin: 5px; border-radius: 10px; max-width: 80%; word-wrap: break-word; }
        .chat-message.sent { background: #007bff; color: white; text-align: right; margin-left: auto; }
        .chat-message.received { background: #e9e9e9; margin-right: auto; }
        #chat-input { width: calc(100% - 80px); padding: 10px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 5px; }
        #login-section { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        #login-container { background: white; padding: 30px; border-radius: 10px; text-align: center; box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        #login-button { padding: 12px 24px; background: #4285F4; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; display: flex; align-items: center; margin: 0 auto; }
        #login-button:hover { background: #3367D6; }
        .google-icon { width: 20px; height: 20px; margin-right: 10px; background: white; padding: 5px; border-radius: 3px; }
        .back-button { background: #6c757d; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; margin-bottom: 10px; }
        .chat-input-container { display: flex; gap: 5px; }
        .send-button { background: #007bff; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; }
        .header { display: flex; align-items: center; margin-bottom: 15px; }
        .header img { width: 40px; height: 40px; border-radius: 50%; margin-right: 10px; }
        .no-messages { text-align: center; color: #777; padding: 20px; }
        .timestamp { font-size: 0.7em; color: #888; display: block; margin-top: 5px; }
    </style>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDslfjDqEpqQekNxh9e4OqYYkxdf2TUI7E&libraries=places"></script>
</head>
<body>
    <!-- Giriş Ekranı -->
    <div id="login-section">
        <div id="login-container">
            <h2>Sosyal Harita ve Mesajlaşma</h2>
            <p>Haritada arkadaşlarını görüntüle ve mesajlaş</p>
            <button id="login-button">
                <img class="google-icon" src="https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg">
                Google ile Oturum Aç
            </button>
        </div>
    </div>

    <!-- Kullanıcı Adı Giriş Popup -->
    <div id="username-popup" style="display: none;">
        <div id="username-form">
            <h3>Lütfen Kullanıcı Adı Giriniz</h3>
            <input type="text" id="username-input" placeholder="Kullanıcı Adı" style="width: 100%; padding: 10px; margin: 15px 0; border: 1px solid #ddd; border-radius: 5px;">
            <button onclick="saveUsername()" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">Kaydet</button>
        </div>
    </div>

    <!-- Harita Bölümü -->
    <div id="map"></div>

    <!-- Mesajlar Bölümü -->
    <div id="messages-section">
        <div class="header">
            <h3>Mesajlar</h3>
        </div>
        <div id="messages-list">
            <div class="no-messages">Henüz mesajınız yok</div>
        </div>
    </div>

    <!-- Sohbet Bölümü -->
    <div id="chat-section">
        <button class="back-button" onclick="showSection('messages')">&lt; Geri</button>
        <div class="header">
            <img id="chat-user-photo" src="">
            <h3>Sohbet: <span id="chat-with"></span></h3>
        </div>
        <div id="chat-messages"></div>
        <div class="chat-input-container">
            <input type="text" id="chat-input" placeholder="Mesaj yaz...">
            <button class="send-button" onclick="sendMessage()">Gönder</button>
        </div>
    </div>

    <!-- Alt Menü -->
    <div id="bottom-nav">
        <button id="home-btn" class="active" onclick="showSection('map')">Harita</button>
        <button id="messages-btn" onclick="showSection('messages')">Mesajlar</button>
    </div>

    <script>
        // Firebase Konfigürasyonu
        const firebaseConfig = {
            apiKey: "AIzaSyBzUyATE4CUGvtIeZ5pf0hLreaFF4p3rSM",
            authDomain: "silicon-park-462509-r3.firebaseapp.com",
            projectId: "silicon-park-462509-r3",
            storageBucket: "silicon-park-462509-r3.appspot.com",
            messagingSenderId: "463275849598",
            appId: "1:463275849598:web:19ffa6e6e5e1ff5077252f",
            measurementId: "G-8CTH7CQ2SS"
        };

        // Firebase Başlatma
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        let map, userMarker, markers = {};
        let currentUserId, currentUsername, currentUserPhoto, currentChatUserId, currentChatUsername, currentChatPhoto;
        let locationWatchId;

        // Google ile Oturum Açma
        document.getElementById('login-button').addEventListener('click', () => {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider).catch(error => {
                console.error('Oturum açma hatası:', error);
                alert('Oturum açma hatası: ' + error.message);
            });
        });

        // Kullanıcı Durumu Kontrolü
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUserId = user.uid;
                currentUserPhoto = user.photoURL;
                document.getElementById('login-section').style.display = 'none';
                checkUsername(user);
                initMap(user);
            } else {
                document.getElementById('login-section').style.display = 'flex';
                if (locationWatchId) {
                    navigator.geolocation.clearWatch(locationWatchId);
                }
            }
        });

        // Kullanıcı Adı Kontrolü ve Popup
        function checkUsername(user) {
            db.ref('users/' + user.uid).once('value').then(snapshot => {
                if (!snapshot.exists() || !snapshot.val().username) {
                    document.getElementById('username-popup').style.display = 'flex';
                } else {
                    currentUsername = snapshot.val().username;
                    updateUserLocation(user);
                }
            }).catch(error => {
                console.error('Kullanıcı adı kontrol hatası:', error);
            });
        }

        // Kullanıcı Adı Kaydetme
        function saveUsername() {
            const username = document.getElementById('username-input').value.trim();
            if (username) {
                db.ref('users/' + currentUserId).set({
                    username: username,
                    photoURL: auth.currentUser.photoURL,
                    location: { lat: 0, lng: 0 }
                }).then(() => {
                    currentUsername = username;
                    document.getElementById('username-popup').style.display = 'none';
                    updateUserLocation(auth.currentUser);
                }).catch(error => {
                    console.error('Kullanıcı adı kaydetme hatası:', error);
                    alert('Kullanıcı adı kaydedilemedi: ' + error.message);
                });
            } else {
                alert('Lütfen geçerli bir kullanıcı adı giriniz');
            }
        }

        // Harita Başlatma
        function initMap(user) {
            navigator.geolocation.getCurrentPosition(position => {
                const userLocation = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };
                map = new google.maps.Map(document.getElementById('map'), {
                    center: userLocation,
                    zoom: 15,
                    mapTypeControl: false,
                    streetViewControl: false,
                    fullscreenControl: false
                });

                // Kullanıcı İşaretçisi
                userMarker = new google.maps.Marker({
                    position: userLocation,
                    map: map,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 10,
                        fillColor: "#4285F4",
                        fillOpacity: 1,
                        strokeColor: "#FFFFFF",
                        strokeWeight: 2
                    },
                    title: 'Siz'
                });

                // Konum takibi başlat
                startLocationTracking(user);

                // Diğer Kullanıcıları Yükleme
                loadOtherUsers();
            }, (error) => {
                console.error('Konum hatası:', error);
                alert('Konum alınamadı, varsayılan konum kullanılıyor.');
                
                // İstanbul varsayılan konum
                const defaultLocation = { lat: 41.0086, lng: 28.9784 };
                map = new google.maps.Map(document.getElementById('map'), {
                    center: defaultLocation,
                    zoom: 10
                });
                
                userMarker = new google.maps.Marker({
                    position: defaultLocation,
                    map: map,
                    title: 'Siz'
                });
                
                startLocationTracking(user);
                loadOtherUsers();
            }, {
                enableHighAccuracy: true,
                timeout: 5000,
                maximumAge: 0
            });
        }

        // Konum takibi başlatma
        function startLocationTracking(user) {
            if (locationWatchId) {
                navigator.geolocation.clearWatch(locationWatchId);
            }
            
            locationWatchId = navigator.geolocation.watchPosition(
                position => {
                    const newLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    
                    // Kullanıcı işaretçisini güncelle
                    if (userMarker) {
                        userMarker.setPosition(newLocation);
                    }
                    
                    // Haritayı kullanıcının konumuna kaydır
                    map.panTo(newLocation);
                    
                    // Firebase'de konumu güncelle
                    db.ref('users/' + user.uid).update({
                        location: newLocation
                    });
                },
                error => {
                    console.error('Konum takip hatası:', error);
                },
                {
                    enableHighAccuracy: true,
                    maximumAge: 10000,
                    timeout: 5000
                }
            );
        }

        // Diğer Kullanıcıları Haritaya Ekleme
        function loadOtherUsers() {
            db.ref('users').on('value', snapshot => {
                snapshot.forEach(child => {
                    const userData = child.val();
                    const userId = child.key;
                    
                    // Kendi kullanıcımızı haritada göstermeyelim
                    if (userId === currentUserId || !userData.location) return;
                    
                    // Kullanıcı konumu
                    const userLocation = new google.maps.LatLng(
                        userData.location.lat,
                        userData.location.lng
                    );
                    
                    // İşaretçi zaten varsa konumunu güncelle
                    if (markers[userId]) {
                        markers[userId].setPosition(userLocation);
                        return;
                    }
                    
                    // Yeni işaretçi oluştur
                    const marker = new google.maps.Marker({
                        position: userLocation,
                        map: map,
                        icon: {
                            path: google.maps.SymbolPath.CIRCEL,
                            scale: 8,
                            fillColor: "#EA4335",
                            fillOpacity: 1,
                            strokeColor: "#FFFFFF",
                            strokeWeight: 2
                        },
                        title: userData.username
                    });
                    
                    // İşaretçi tıklama olayı
                    marker.addListener('click', () => {
                        currentChatUserId = userId;
                        currentChatUsername = userData.username;
                        currentChatPhoto = userData.photoURL;
                        
                        document.getElementById('chat-with').textContent = userData.username;
                        document.getElementById('chat-user-photo').src = userData.photoURL;
                        showSection('chat');
                        loadChatMessages();
                    });
                    
                    markers[userId] = marker;
                });
            }, error => {
                console.error('Kullanıcı yükleme hatası:', error);
            });
        }

        // Bölüm Değiştirme
        function showSection(section) {
            document.getElementById('map').style.display = section === 'map' ? 'block' : 'none';
            document.getElementById('messages-section').style.display = section === 'messages' ? 'block' : 'none';
            document.getElementById('chat-section').style.display = section === 'chat' ? 'block' : 'none';
            
            document.getElementById('home-btn').classList.toggle('active', section === 'map');
            document.getElementById('messages-btn').classList.toggle('active', section === 'messages' || section === 'chat');
            
            if (section === 'messages') {
                loadMessages();
            } else if (section === 'map') {
                // Haritayı yeniden boyutlandır
                setTimeout(() => {
                    if (map) google.maps.event.trigger(map, 'resize');
                }, 100);
            }
        }

        // Mesajları Yükleme
        function loadMessages() {
            const messagesList = document.getElementById('messages-list');
            messagesList.innerHTML = '';
            
            db.ref('messages/' + currentUserId).once('value').then(snapshot => {
                if (!snapshot.exists() || snapshot.numChildren() === 0) {
                    messagesList.innerHTML = '<div class="no-messages">Henüz mesajınız yok</div>';
                    return;
                }
                
                snapshot.forEach(child => {
                    const senderId = child.key;
                    const lastMessage = child.val().lastMessage;
                    const timestamp = child.val().timestamp;
                    
                    db.ref('users/' + senderId).once('value').then(senderSnapshot => {
                        if (!senderSnapshot.exists()) return;
                        
                        const senderData = senderSnapshot.val();
                        const div = document.createElement('div');
                        div.className = 'message-item';
                        
                        div.innerHTML = `
                            <img src="${senderData.photoURL || 'https://via.placeholder.com/40'}">
                            <div>
                                <strong>${senderData.username}</strong>
                                <div>${lastMessage || 'Yeni sohbet başlatıldı'}</div>
                                <small class="timestamp">${formatTimestamp(timestamp)}</small>
                            </div>
                        `;
                        
                        div.onclick = () => {
                            currentChatUserId = senderId;
                            currentChatUsername = senderData.username;
                            currentChatPhoto = senderData.photoURL;
                            
                            document.getElementById('chat-with').textContent = senderData.username;
                            document.getElementById('chat-user-photo').src = senderData.photoURL || 'https://via.placeholder.com/40';
                            showSection('chat');
                            loadChatMessages();
                        };
                        
                        messagesList.appendChild(div);
                    });
                });
            }).catch(error => {
                console.error('Mesaj yükleme hatası:', error);
                messagesList.innerHTML = '<div class="no-messages">Mesajlar yüklenirken hata oluştu</div>';
            });
        }

        // Sohbet Mesajlarını Yükleme
        function loadChatMessages() {
            const chatMessages = document.getElementById('chat-messages');
            chatMessages.innerHTML = '';
            
            if (!currentChatUserId) return;
            
            const chatId = [currentUserId, currentChatUserId].sort().join('_');
            
            db.ref('chats/' + chatId).orderByChild('timestamp').on('value', snapshot => {
                chatMessages.innerHTML = '';
                
                if (!snapshot.exists()) {
                    chatMessages.innerHTML = '<div class="no-messages">Henüz mesaj yok. İlk mesajı sen gönder!</div>';
                    return;
                }
                
                snapshot.forEach(child => {
                    const msg = child.val();
                    const div = document.createElement('div');
                    div.className = `chat-message ${msg.senderId === currentUserId ? 'sent' : 'received'}`;
                    
                    div.innerHTML = `
                        <div>${msg.text}</div>
                        <small class="timestamp">${formatTimestamp(msg.timestamp)}</small>
                    `;
                    
                    chatMessages.appendChild(div);
                });
                
                // En son mesaja kaydır
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }, error => {
                console.error('Sohbet yükleme hatası:', error);
                chatMessages.innerHTML = '<div class="no-messages">Mesajlar yüklenirken hata oluştu</div>';
            });
        }

        // Mesaj Gönderme
        function sendMessage() {
            const text = document.getElementById('chat-input').value.trim();
            if (!text || !currentChatUserId) return;
            
            const chatId = [currentUserId, currentChatUserId].sort().join('_');
            const timestamp = Date.now();
            
            // Mesajı sohbete kaydet
            db.ref('chats/' + chatId).push({
                senderId: currentUserId,
                text: text,
                timestamp: timestamp
            }).then(() => {
                document.getElementById('chat-input').value = '';
                
                // Son mesaj bilgisini her iki kullanıcı için de güncelle
                db.ref('messages/' + currentUserId + '/' + currentChatUserId).set({
                    lastMessage: text,
                    timestamp: timestamp
                });
                
                db.ref('messages/' + currentChatUserId + '/' + currentUserId).set({
                    lastMessage: text,
                    timestamp: timestamp
                });
            }).catch(error => {
                console.error('Mesaj gönderme hatası:', error);
                alert('Mesaj gönderilemedi: ' + error.message);
            });
        }

        // Timestamp'i biçimlendirme
        function formatTimestamp(timestamp) {
            if (!timestamp) return '';
            
            const date = new Date(timestamp);
            const now = new Date();
            
            // Bugün mü kontrolü
            if (date.toDateString() === now.toDateString()) {
                return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            }
            
            // Dün mü kontrolü
            const yesterday = new Date(now);
            yesterday.setDate(yesterday.getDate() - 1);
            
            if (date.toDateString() === yesterday.toDateString()) {
                return 'Dün ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            }
            
            // Bu yıl içinde mi
            if (date.getFullYear() === now.getFullYear()) {
                return date.toLocaleDateString([], { month: 'short', day: 'numeric' });
            }
            
            return date.toLocaleDateString();
        }

        // Enter tuşu ile mesaj gönderme
        document.getElementById('chat-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    </script>
</body>
</html>