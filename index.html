<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lovixa | Ger√ßek-Zamanlƒ± Konum Payla≈üƒ±mƒ±</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    
    <style>
        /* T√ºm tema CSS'leri */
        :root {
            --bg: #0d0d0d;
            --surface: #1e1e1e;
            --primary: #4caf50;
            --accent: #4285f4;
            --text: #fff;
            --radius: 16px;
            --trans: all 0.2s ease;
            --top-h: 56px;
            --bot-h: 56px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: "Segoe UI", sans-serif;
        }

        body {
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            overflow: hidden;
        }

        .centered {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        .card {
            background: var(--surface);
            padding: 2rem;
            border-radius: var(--radius);
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.4);
            display: flex;
            flex-direction: column;
            gap: 1rem;
            width: 100%;
            max-width: 400px;
        }

        h2 {
            text-align: center;
            font-size: 1.8rem;
            margin-bottom: 1rem;
        }

        input, button {
            padding: 0.9rem;
            font-size: 1rem;
            border-radius: 10px;
            border: none;
            transition: var(--trans);
        }

        input {
            background: #2a2a2a;
            border: 1px solid #3a3a3a;
            color: var(--text);
        }

        input:focus {
            border-color: var(--primary);
            outline: none;
        }

        button {
            background: var(--primary);
            color: #fff;
            cursor: pointer;
            font-weight: 600;
        }

        button:hover {
            background: #43a047;
            transform: translateY(-2px);
        }

        button.google {
            background: var(--accent);
        }

        .link {
            text-align: center;
            font-size: 0.95rem;
            margin-top: 0.5rem;
        }

        .link a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
        }

        .link a:hover {
            text-decoration: underline;
        }

        /* Dashboard */
        .topbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--top-h);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 12px;
            background: var(--surface);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
            z-index: 10;
        }

        .icon {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text);
            cursor: pointer;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: var(--trans);
        }

        .icon:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .map {
            position: absolute;
            top: var(--top-h);
            bottom: var(--bot-h);
            left: 0;
            right: 0;
            z-index: 1;
        }

        .loader {
            position: absolute;
            top: var(--top-h);
            bottom: var(--bot-h);
            left: 0;
            right: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.8);
            z-index: 9;
        }

        .loader::after {
            content: "";
            width: 48px;
            height: 48px;
            border: 5px solid rgba(255, 255, 255, 0.2);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: var(--bot-h);
            display: flex;
            justify-content: space-around;
            align-items: center;
            background: var(--surface);
            box-shadow: 0 -2px 6px rgba(0, 0, 0, 0.4);
            z-index: 10;
        }

        .avatar-marker {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background-size: cover;
            background-position: center;
            border: 3px solid var(--primary);
            box-shadow: 0 0 6px rgba(0, 0, 0, 0.6);
        }

        /* Sayfa ge√ßi≈üleri */
        .page {
            display: none;
            height: 100%;
        }

        .page.active {
            display: block;
        }

        /* Logo */
        .logo {
            font-weight: 800;
            letter-spacing: 1px;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            font-size: 1.8rem;
        }

        /* Hata mesajƒ± */
        .error-message {
            background: #f44336;
            color: white;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            margin-top: 10px;
            display: none;
        }

        /* Ba≈üarƒ± mesajƒ± */
        .success-message {
            background: var(--primary);
            color: white;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            margin-top: 10px;
            display: none;
        }
    </style>
</head>
<body>
    <!-- Giri≈ü Sayfasƒ± -->
    <div id="login-page" class="page active">
        <section class="centered">
            <div class="card">
                <h2 class="logo">LOVIXA</h2>
                <p style="text-align: center; margin-bottom: 1.5rem; opacity: 0.8;">Ger√ßek zamanlƒ± konum payla≈üƒ±m platformu</p>
                
                <div class="error-message" id="login-error"></div>
                
                <input type="email" id="email" placeholder="E-posta adresi">
                <input type="password" id="password" placeholder="≈ûifre">
                <button id="login-btn">Giri≈ü Yap</button>
                <button id="google-btn" class="google">Google ile Giri≈ü</button>
                
                <p class="link">
                    Hesabƒ±n yok mu? <a href="#" id="go-to-register">Kayƒ±t Ol</a>
                </p>
            </div>
        </section>
    </div>

    <!-- Kayƒ±t Sayfasƒ± -->
    <div id="register-page" class="page">
        <section class="centered">
            <div class="card">
                <h2 class="logo">LOVIXA</h2>
                <p style="text-align: center; margin-bottom: 1.5rem; opacity: 0.8;">Yeni hesap olu≈ütur</p>
                
                <div class="error-message" id="register-error"></div>
                <div class="success-message" id="register-success">Kayƒ±t ba≈üarƒ±lƒ±! Giri≈ü yapƒ±lƒ±yor...</div>
                
                <input type="email" id="reg-email" placeholder="E-posta adresi">
                <input type="password" id="reg-password" placeholder="≈ûifre (min 6 kr.)">
                <button id="register-btn">Kayƒ±t Ol</button>
                <button id="google-register-btn" class="google">Google ile Kayƒ±t Ol</button>
                
                <p class="link">
                    Zaten hesabƒ±n var mƒ±? <a href="#" id="go-to-login">Giri≈ü Yap</a>
                </p>
            </div>
        </section>
    </div>

    <!-- Dashboard Sayfasƒ± -->
    <div id="dashboard-page" class="page">
        <header class="topbar">
            <button id="location-toggle" class="icon">üìç</button>
            <h1 class="logo">LOVIXA</h1>
            <button id="logout-btn" class="icon">‚Ü©Ô∏é</button>
        </header>

        <main id="map" class="map"></main>
        <div id="loader" class="loader"></div>

        <nav class="bottom-nav">
            <a href="#" class="icon" data-page="dashboard">üè†</a>
            <a href="#" class="icon" data-page="messages">üí¨</a>
            <a href="#" class="icon" data-page="profile">üë§</a>
        </nav>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        // Firebase konfig√ºrasyonu
        const firebaseConfig = {
            apiKey: "AIzaSyBzUyATE4CUGvtIeZ5pf0hLreaFF4p3rSM",
            authDomain: "silicon-park-462509-r3.firebaseapp.com",
            projectId: "silicon-park-462509-r3",
            storageBucket: "silicon-park-462509-r3.appspot.com",
            messagingSenderId: "463275849598",
            appId: "1:463275849598:web:19ffa6e6e5e1ff5077252f"
        };

        // Firebase'i ba≈ülat
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Tarayƒ±cƒ±da oturum kalƒ±cƒ±lƒ±ƒüƒ±nƒ± ayarla
        auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
            .catch((error) => {
                console.error("Persistence error:", error);
            });

        // Sayfa ge√ßi≈ü fonksiyonu
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(pageId).classList.add('active');
        }

        // Giri≈ü sayfasƒ±na ge√ßi≈ü
        document.getElementById('go-to-register')?.addEventListener('click', (e) => {
            e.preventDefault();
            showPage('register-page');
        });

        // Kayƒ±t sayfasƒ±ndan giri≈ü sayfasƒ±na ge√ßi≈ü
        document.getElementById('go-to-login')?.addEventListener('click', (e) => {
            e.preventDefault();
            showPage('login-page');
        });

        // Hata mesajƒ± g√∂sterme
        function showError(elementId, message) {
            const errorElement = document.getElementById(elementId);
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            
            // 5 saniye sonra hata mesajƒ±nƒ± gizle
            setTimeout(() => {
                errorElement.style.display = 'none';
            }, 5000);
        }

        // Giri≈ü i≈ülemi
        document.getElementById('login-btn')?.addEventListener('click', async () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const errorElement = document.getElementById('login-error');

            if (!email || !password) {
                showError('login-error', "L√ºtfen e-posta ve ≈üifre giriniz.");
                return;
            }

            try {
                await auth.signInWithEmailAndPassword(email, password);
                showPage('dashboard-page');
            } catch (error) {
                let errorMessage = "Giri≈ü ba≈üarƒ±sƒ±z. ";
                switch (error.code) {
                    case 'auth/invalid-email':
                        errorMessage += "Ge√ßersiz e-posta adresi.";
                        break;
                    case 'auth/user-disabled':
                        errorMessage += "Bu kullanƒ±cƒ± devre dƒ±≈üƒ± bƒ±rakƒ±lmƒ±≈ü.";
                        break;
                    case 'auth/user-not-found':
                        errorMessage += "Bu e-posta adresine sahip kullanƒ±cƒ± bulunamadƒ±.";
                        break;
                    case 'auth/wrong-password':
                        errorMessage += "Hatalƒ± ≈üifre.";
                        break;
                    default:
                        errorMessage += error.message;
                }
                showError('login-error', errorMessage);
                console.error("[LOGIN]", error);
            }
        });

        // Google ile giri≈ü
        document.getElementById('google-btn')?.addEventListener('click', async () => {
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                await auth.signInWithPopup(provider);
                showPage('dashboard-page');
            } catch (error) {
                showError('login-error', "Google giri≈ü hatasƒ±: " + error.message);
                console.error("[GOOGLE LOGIN]", error);
            }
        });

        // Kayƒ±t i≈ülemi
        document.getElementById('register-btn')?.addEventListener('click', async () => {
            const email = document.getElementById('reg-email').value;
            const password = document.getElementById('reg-password').value;
            const errorElement = document.getElementById('register-error');
            const successElement = document.getElementById('register-success');

            if (!email) {
                showError('register-error', "L√ºtfen ge√ßerli bir e-posta adresi giriniz.");
                return;
            }

            if (password.length < 6) {
                showError('register-error', "≈ûifreniz en az 6 karakter olmalƒ±dƒ±r.");
                return;
            }

            try {
                await auth.createUserWithEmailAndPassword(email, password);
                
                // Ba≈üarƒ± mesajƒ±nƒ± g√∂ster
                successElement.style.display = 'block';
                
                // 2 saniye sonra dashboard'a y√∂nlendir
                setTimeout(() => {
                    showPage('dashboard-page');
                }, 2000);
            } catch (error) {
                let errorMessage = "Kayƒ±t ba≈üarƒ±sƒ±z. ";
                switch (error.code) {
                    case 'auth/email-already-in-use':
                        errorMessage += "Bu e-posta adresi zaten kullanƒ±mda.";
                        break;
                    case 'auth/invalid-email':
                        errorMessage += "Ge√ßersiz e-posta adresi.";
                        break;
                    case 'auth/operation-not-allowed':
                        errorMessage += "Bu i≈ülem ≈üu anda izin verilmiyor.";
                        break;
                    case 'auth/weak-password':
                        errorMessage += "≈ûifre √ßok zayƒ±f. Daha g√º√ßl√º bir ≈üifre deneyin.";
                        break;
                    default:
                        errorMessage += error.message;
                }
                showError('register-error', errorMessage);
                console.error("[REGISTER]", error);
            }
        });

        // Google ile kayƒ±t
        document.getElementById('google-register-btn')?.addEventListener('click', async () => {
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                await auth.signInWithPopup(provider);
                showPage('dashboard-page');
            } catch (error) {
                showError('register-error', "Google kayƒ±t hatasƒ±: " + error.message);
                console.error("[GOOGLE REGISTER]", error);
            }
        });

        // √áƒ±kƒ±≈ü i≈ülemi
        document.getElementById('logout-btn')?.addEventListener('click', () => {
            auth.signOut();
            showPage('login-page');
        });

        // Auth state deƒüi≈üikliklerini izle
        auth.onAuthStateChanged((user) => {
            if (user) {
                showPage('dashboard-page');
                initDashboard(user);
            } else {
                showPage('login-page');
            }
        });

        // Dashboard i≈ülemleri
        let map, myMarker, watchId = null, visible = true;
        const others = new Map();

        function initDashboard(user) {
            // Loader'ƒ± kaldƒ±r
            const loader = document.getElementById('loader');
            if (loader) loader.style.display = 'none';

            // Haritayƒ± ba≈ülat
            initMap(user);
        }

        async function initMap(user) {
            // Kullanƒ±cƒ±nƒ±n konumunu al
            try {
                const { coords } = await getCurrentPos();
                
                // Haritayƒ± olu≈ütur
                map = L.map('map', { 
                    zoomControl: false, 
                    attributionControl: false 
                }).setView([coords.latitude, coords.longitude], 14);

                // Dark tema harita katmanƒ±
                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                    subdomains: 'abcd',
                    maxZoom: 19
                }).addTo(map);

                // Kendi marker'ƒ±mƒ±zƒ± olu≈ütur
                myMarker = L.marker([coords.latitude, coords.longitude], {
                    icon: avatarIcon(user.uid)
                }).addTo(map);

                // Konum izlemeyi ba≈ülat
                startWatch(user);

                // Diƒüer kullanƒ±cƒ±larƒ± dinle
                listenOthers(user.uid);
            } catch (error) {
                console.error("Konum alƒ±namadƒ±:", error);
                // Varsayƒ±lan bir konumla ba≈ülat
                map = L.map('map').setView([41.0082, 28.9784], 13);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                    subdomains: 'abcd'
                }).addTo(map);
                
                // Hata durumunda loader'ƒ± kaldƒ±r
                const loader = document.getElementById('loader');
                if (loader) loader.style.display = 'none';
                
                alert("Konum bilgisi alƒ±namadƒ±. L√ºtfen konum eri≈üimine izin verin.");
            }
        }

        function startWatch(user) {
            const toggle = document.getElementById('location-toggle');
            if (toggle) {
                toggle.onclick = () => {
                    visible = !visible;
                    if (visible) {
                        map.addLayer(myMarker);
                        toggle.textContent = 'üìç';
                    } else {
                        map.removeLayer(myMarker);
                        toggle.textContent = 'üö´';
                    }
                };
            }

            watchId = navigator.geolocation.watchPosition(async (position) => {
                const { latitude: lat, longitude: lng } = position.coords;
                if (myMarker) myMarker.setLatLng([lat, lng]);
                
                // Firestore'a konumu yaz
                await db.collection("activeUsers").doc(user.uid).set({
                    lat,
                    lng,
                    ts: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
            }, console.error, { enableHighAccuracy: true, maximumAge: 10000 });
        }

        function listenOthers(myUid) {
            db.collection("activeUsers").onSnapshot((snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    const uid = change.doc.id;
                    if (uid === myUid) return;

                    const data = change.doc.data();
                    if (!data.lat || !data.lng) return;

                    if (change.type === "removed") {
                        if (others.has(uid)) {
                            map.removeLayer(others.get(uid));
                            others.delete(uid);
                        }
                    } else {
                        let marker = others.get(uid);
                        if (!marker) {
                            marker = L.marker([data.lat, data.lng], { 
                                icon: avatarIcon(uid) 
                            }).addTo(map);
                            others.set(uid, marker);
                        } else {
                            marker.setLatLng([data.lat, data.lng]);
                        }
                    }
                });
            });
        }

        function avatarIcon(uid) {
            return L.divIcon({
                html: `<div class="avatar-marker" style="background-image:url(https://i.pravatar.cc/100?u=${uid})"></div>`,
                iconSize: [44, 44],
                className: ""
            });
        }

        function getCurrentPos() {
            return new Promise((resolve, reject) => {
                navigator.geolocation.getCurrentPosition(resolve, reject, { 
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                });
            });
        }
    </script>
</body>
</html>